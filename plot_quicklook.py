from matplotlib.colors import LogNorm
import matplotlib.dates as mdates
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import glob
import string
import pytz

pop_binedges = '0.119552706	0.140894644	0.169068337	0.204226949	0.227523895	0.253291842	0.279285719	0.35426882	0.604151175	0.705102841	0.785877189	1.100686925	1.117622254	1.765832382	2.690129739	3.014558062 4.392791391'
pop_binedges = np.fromstring(pop_binedges, dtype=float, sep="\t")
pop_midbin = (pop_binedges[1:] + pop_binedges[:-1])/2

def plot_quicklook(df):

    if df['datetime'][0] < pd.Timestamp('20221003', tz='UTC'):
        cda_midbin = '0.475328874	0.476797513	0.478175666	0.479502075	0.480855492	0.482239192	0.483776821	0.485514795	0.487586124	0.490033954	0.493015369	0.49644285	0.500526891	0.504620049	0.508623279	0.512432791	0.516276412	0.519917789	0.523446881	0.526657368	0.529644951	0.532170415	0.534453013	0.536612172	0.538707124	0.540707499	0.542704885	0.544602005	0.546412089	0.548115794	0.54976444	0.551336908	0.552945782	0.5545795	0.556307547	0.558111326	0.560094002	0.56230309	0.564890776	0.567889907	0.571592672	0.576088823	0.581680177	0.588617321	0.601561496	0.630479813	0.676961544	0.710966886	0.735991613	0.756999913	0.775663514	0.795802163	0.817335328	0.834507604	0.851033998	0.86681952	0.883636475	0.904097147	0.945168374	0.987512487	1.00945989	1.024622743	1.037300638	1.04742767	1.055919888	1.062703414	1.067781829	1.071556532	1.074791681	1.07782548	1.081217504	1.085261064	1.090688654	1.099784657	1.101313854	1.134070536	1.209881892	1.226633942	1.276581131	1.281214165	1.299169605	1.401316835	1.41500474	1.488659509	1.499543839	1.530187633	1.612875286	1.666529026	1.676728327	1.692803248	1.697021378	1.743202139	1.774124289	1.79524413	1.845877084	1.860421324	2.020064767	2.022618315	2.088301883	2.15270898	2.166822976	2.19656516	2.196871589	2.366985679	2.567716135	2.713412113	3.023724973	3.116313593	3.258662351	3.499997015	3.560935854	3.656816689	3.701894939	4.128937642	4.246310184	4.294054709	4.442235484	4.449948153	4.653026664	4.653982923	4.67225491	4.861758846	5.128331636	5.178882979	5.3989097	5.488764992	5.697755771	5.796959675	5.849201526	5.861379666	6.181802879	6.234781395	6.270167934	6.456362015	6.664095866	6.818273185	7.045264319	7.199039758	7.744351806	8.149762235	8.389541055	9.106277016	9.376108012	9.458106894	9.720177509	9.891769321	9.893218147	10.08342955	11.13544922	11.3674229	11.97956261	12.05205985	12.13275325	12.52580911	12.65504996	12.74203407	13.5130931	13.60890061	14.00643198	14.01971045	14.62845349	14.68718025	15.08350885	15.08634042	15.26579923	15.48530688	15.78181646	15.87183591	15.88837124	15.99151022	16.21562139	16.3392285	17.09296412	17.30950528	17.49875152	17.91853132	18.81127331	18.88275366	19.49931861	20.50310055	20.67596729	21.43256304	21.66692463	22.38056288	22.41687813	23.32114574	23.59800118	24.6884587	26.15910161	26.40985223	26.54907612	26.82122253	27.95378788	28.31828571	28.62308926	28.9859605	31.70831679	33.30483755	33.31872983	33.47237149	33.83613691	34.14117219	34.29535607	35.96238407	36.45040779	36.96988842	39.31445632	39.80082648	39.97625745	40.4735219	41.12239047	41.36883415	41.44721931	42.14962289	43.5535701	44.66132244	45.18348652	45.4997003	45.62804903	46.07948013	47.22685994	47.31823406	48.04153067	50.09042257	51.10002286	51.70165447	54.88557633	54.89575025	56.84483279	57.63884448	59.89426308	62.48060031	65.02975953	65.31940219	66.72726474	66.93637203	68.96794765	70.10028923	73.92440633	74.13015358	74.791476	78.61039438	81.12774565	81.78167273	84.31901307	87.67904454	87.73430049	88.07791102	88.92650157	89.09216846	89.90121531	90.14220699	93.09415699	94.34675245	95.23367622	99.56794522'

        cda_midbin = np.fromstring(cda_midbin, dtype=float, sep="\t")
    else:
        cda_midbin = '0.19227805	0.195682843	0.198983343	0.20211289	0.205059225	0.207724906	0.210261443	0.212640197	0.214941426	0.217106159	0.219184031	0.221069702	0.222864072	0.224475983	0.226007321	0.227451721	0.228935989	0.230420372	0.232001183	0.23365707	0.235515886	0.237498239	0.2396823	0.24214974	0.245031001	0.248355538	0.252390654	0.257053516	0.262427305	0.268474128	0.275372623	0.282991081	0.29186836	0.307406033	0.399923672	0.402950618	0.406095451	0.409547965	0.413400206	0.41751259	0.422044242	0.42680368	0.431777327	0.436801452	0.441881131	0.446916295	0.451869098	0.456536345	0.461007333	0.465043657	0.468581314	0.47159057	0.474204957	0.476473849	0.478591721	0.480677994	0.48300681	0.485758086	0.489139191	0.49325646	0.498338142	0.504028299	0.509556422	0.514585055	0.519317611	0.523556277	0.527348524	0.530511705	0.533271375	0.535775297	0.538169182	0.540358784	0.542467011	0.544426232	0.546291497	0.548017646	0.549703069	0.551325101	0.552997124	0.554673551	0.55647017	0.558378723	0.56050201	0.562815814	0.565485426	0.568582588	0.572346583	0.576807678	0.58246436	0.589712032	0.604097302	0.635149648	0.681785255	0.713426518	0.737929379	0.758135266	0.777197248	0.798828865	0.820820152	0.838396525	0.855899917	0.87246732	0.89199909	0.922871585	0.974103329	1.005591361	1.023715678	1.037668183	1.049003877	1.057952428	1.064979646	1.069897601	1.073922024	1.077493706	1.081305379	1.085788096	1.091724556	1.102779697	1.143265693	1.143675182	1.163586446	1.246663736	1.281034981	1.289349324	1.374261238	1.401296895	1.415000046	1.428202899	1.456793	1.496478358	1.51027838	1.547046871	1.573966487	1.607826932	1.61288441	1.673303193	1.682765991	1.700659399	1.712959793	1.752359685	1.764561073	1.963587787	1.975472036	2.018506015	2.109050442	2.137584399	2.163430246	2.198779576	2.206574596	2.521503927	2.600807492	2.930644138	3.224767773	3.26559294	3.299391563	3.468402268	3.55387855	4.015901324	4.14533435	4.15481853	4.204793932	4.306427442	4.484413043	4.509869078	4.659718938	5.012878336	5.02631696	5.094605209	5.216818908	5.421478915	5.465600408	5.466342553	5.792080706	5.800707245	5.801478634	5.896858039	6.314835626	6.344372707	6.479563152	6.717522876	6.889473096	7.196842924	7.385283045	7.599896247	7.722296477	7.896454473	7.921113299	8.543756839	9.095455989	9.16683766	9.340296673	9.527426832	9.70141772	11.10018093	11.16424998	11.373042	12.25953607	12.46820121	12.59184634	12.89654491	12.91132697	13.34641457	13.9706481	14.15548153	14.28459638	14.42672431	14.59952971	15.21856797	15.50879655	15.60034721	15.92875268	16.35351736	16.37616054	16.42409686	16.83332527	17.12982341	17.31701994	18.02256439	18.16605357	18.20476917	18.49994924	19.20076453	19.39154934	21.89001477	21.99989778	21.99993105	23.30541595	23.58030073	23.99543799	24.04375695	25.18505013	25.56282424	26.15732199	26.34740847	26.4192903	27.51664818	27.78718441	28.68872451	30.81710534	31.19347354	32.34758429	32.53704978	33.36324834	33.46006639	33.50015573	34.33790788	34.94707083	35.5539353	35.59328655	35.70406319	35.98700435	36.75952545	37.4023428	39.35282551	39.88672896	41.79105594'

        cda_midbin = np.fromstring(cda_midbin, dtype=float, sep="\t")
    cda_midbin = cda_midbin[81:]
    fig, ax = plt.subplot_mosaic([
        ['press', 'mcda'],
        ['temp', 'mcda'],
        ['RH', 'pop'],
        ['cpc', 'pop']
    ],
    figsize=(9, 6), sharex=True, constrained_layout=True)

    ax['press'].plot(df['datetime'], df['press_bme (hPa)'], '.')
    ax['press'].set_ylabel('press_bme (hPa)')
    ax['press'].grid()

    ax['temp'].plot(df['datetime'], df['temp_bme (C)'], '.')
    ax['temp'].set_ylabel(r'temp_bme (C)')
    ax['temp'].grid()

    ax['RH'].plot(df['datetime'], df['rh_bme (%)'], '.')
    ax['RH'].set_ylabel(r'rh_bme (%)')
    ax['RH'].grid()

    ax['cpc'].plot(df['datetime'], df['N_conc_cpc(1/ccm)'], '.')
    ax['cpc'].set_ylabel(r'N_conc_cpc(1/ccm)')
    ax['cpc'].grid()
    ax['cpc'].set_yscale('log')

    grp_avg = df.set_index('datetime').resample('5min').mean().reset_index()
    p = ax['mcda'].pcolormesh(grp_avg['datetime'],
                              cda_midbin,
                              grp_avg[[x for x in df.columns if '_mcda (dN/dlogDp)' in x]].T,
                              norm=LogNorm(vmax=10, vmin=0.01),
                              cmap='jet')
    ax['mcda'].set_yscale('log')
    ax['mcda'].set_ylabel(r'Size ($\mu m$)')
    cbar = fig.colorbar(p, ax=ax['mcda'])
    cbar.ax.set_ylabel(r'dN/dlogDp ($cm^{-3}$) miniCDA', rotation=90)

    p = ax['pop'].pcolormesh(grp_avg['datetime'],
                             pop_midbin,
                             grp_avg[[x for x in df.columns if '_pops (dN/dlogDp)' in x]].T,
                             norm=LogNorm(vmax=10, vmin=0.01),
                             cmap='jet')
    ax['pop'].set_yscale('log')
    ax['pop'].set_xlim(ax['mcda'].get_xlim())
    ax['pop'].set_ylabel(r'Size ($\mu m$)')
    cbar = fig.colorbar(p, ax=ax['pop'])
    cbar.ax.set_ylabel(r'dN/dlogDp ($cm^{-3}$) POP', rotation=90)

    ax['cpc'].set_xlabel('Time (UTC)')
    ax['pop'].set_xlabel('Time (UTC)')

    for n, (_, ax_) in enumerate(ax.items()):
        ax_.xaxis.set_major_formatter(mdates.DateFormatter('%H:%M', tz=pytz.timezone('UTC')))
        ax_.xaxis.set_tick_params(labelbottom=True)
        ax_.text(-0.0, 1.05, '(' + string.ascii_lowercase[n] + ')',
            transform=ax_.transAxes, size=12)
    return fig

file_path = r'C:\Users\le\OneDrive - Ilmatieteen laitos\Campaigns\Pace2022\FMI balloon payload\Processed_data/'

file_list = glob.glob(file_path + '*.csv')
for file in file_list:
    df = pd.read_csv(file)
    df['datetime'] = pd.to_datetime(df['datetime'])
    df = df.replace(-9999.9, np.nan)
    fig = plot_quicklook(df)
    save_time = df.datetime[0].strftime("%Y%m%d_%H%M")
    fig.savefig(file_path + 'quicklook' + save_time + '.png', dpi=500)
    plt.close()
    print(f'Plot {save_time} saved')